<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b5cf6">
    <title>Supervisi√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="email-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html {
            /* Prevenir zoom en inputs en iOS */
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* Scroll suave */
            scroll-behavior: smooth;
            /* Optimizaciones de rendimiento */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f5f5f5;
            color: #2d3748;
            line-height: 1.5;
            overflow-x: hidden;
            /* Prevenir sobre-scroll */
            overscroll-behavior: none;
            /* Safe areas para notch/botones Android */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* Optimizaci√≥n de im√°genes y contenido */
        img, video {
            max-width: 100%;
            height: auto;
        }

        /* Mejorar rendimiento de animaciones */
        * {
            will-change: auto;
        }

        .topbar {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: max(env(safe-area-inset-top), 12px) 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .brand-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand i {
            color: white;
            font-size: 24px;
        }

        .brand h1 {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .user-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            flex-wrap: wrap;
        }

        .stats-mini {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
            padding: 6px 10px;
            border-radius: 8px;
            flex: 1;
            min-width: 0;
        }

        .stat-item i {
            font-size: 14px;
            flex-shrink: 0;
        }

        .stat-number {
            font-weight: 700;
            color: white;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .stat-number.pending {
            background: #fbbf24;
            color: #78350f;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 8px;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .user-role {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
        }

        .logout-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            /* Mejor √°rea t√°ctil */
            min-height: 44px;
            min-width: 44px;
        }

        .logout-btn:active {
            background: rgba(255,255,255,0.25);
            transform: scale(0.95);
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 16px;
            padding-bottom: max(env(safe-area-inset-bottom), 16px);
        }

        .page-header {
            margin-bottom: 20px;
        }

        .page-header h2 {
            font-size: 22px;
            color: #111827;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .page-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 2px;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border-radius: 12px;
            white-space: nowrap;
            flex-shrink: 0;
            /* Mejor √°rea t√°ctil */
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab:active {
            transform: scale(0.95);
        }

        .tab.active {
            color: white;
            background: #8b5cf6;
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .tab-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #78350f;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }

        .tab.active .tab-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert.show {
            display: flex;
            animation: slideInDown 0.3s ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d1fae5;
            border: none;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border: none;
            color: #991b1b;
        }

        .reprog-card {
            background: white;
            border: none;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .reprog-card:active {
            transform: scale(0.98);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f3f4f6;
            gap: 12px;
        }

        .card-info h3 {
            font-size: 15px;
            color: #1f2937;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 12px;
            color: #9ca3af;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-answered {
            background: #d1fae5;
            color: #065f46;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 12px 0;
            background: #fafafa;
            border-radius: 12px;
            padding: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 700;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .data-table tbody tr:active {
            background: #f9fafb;
        }

        .editable-cell input,
        .editable-cell textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            /* Tama√±o m√≠nimo 16px para prevenir zoom en iOS */
            min-height: 44px;
        }

        .editable-cell input:focus,
        .editable-cell textarea:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .editable-cell textarea {
            min-width: 180px;
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Mejor √°rea t√°ctil */
            min-height: 48px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:disabled {
            background: #c4b5fd;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .actions-bar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .empty-text {
            font-size: 15px;
            color: #6b7280;
            font-weight: 500;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
        }

        /* Pull to refresh indicator (opcional) */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            padding: 10px 20px;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            z-index: 999;
        }

        .pull-to-refresh.active {
            transform: translateX(-50%) translateY(0);
        }

        /* Optimizaci√≥n de rendimiento */
        .reprog-card,
        .btn,
        .tab {
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Scroll suave en contenedores */
        .table-container,
        .tabs {
            scroll-padding: 16px;
        }

        /* Mejorar legibilidad en m√≥vil */
        @media (max-width: 768px) {
            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }

            .card-meta {
                flex-direction: column;
                gap: 6px;
            }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .topbar {
                padding: 8px 16px;
            }

            .page-header {
                margin-bottom: 12px;
            }

            .page-header h2 {
                font-size: 18px;
            }
        }

        /* Prevenir selecci√≥n de texto en elementos interactivos */
        .btn,
        .tab,
        .logout-btn {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Animaci√≥n de carga de contenido */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Skeleton loading (opcional para mejora futura) */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Indicador de conexi√≥n offline */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #dc2626;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            z-index: 10000;
            display: none;
        }

        .offline-banner.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Indicador offline -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i> Sin conexi√≥n a internet
    </div>

    <div class="topbar">
        <div class="brand">
            <div class="brand-left">
                <i class="fas fa-tasks"></i>
                <h1>Supervisi√≥n</h1>
            </div>
            <div class="brand-left">
                <i class="fas fa-tasks"></i>
                <h1>Supervisi√≥n</h1>
            </div>
            <button class="logout-btn" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        <div class="user-section">
            <div class="stats-mini">
                <div class="stat-item">
                    <i class="fas fa-clock"></i>
                    <span class="stat-number pending" id="pendingCount">0</span>
                    <span style="font-size: 12px;">Pendientes</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-check-circle"></i>
                    <span class="stat-number" id="answeredCount">0</span>
                    <span style="font-size: 12px;">Respondidas</span>
                </div>
            </div>
            <div class="user-info">
                <i class="fas fa-user-circle" style="font-size: 20px;"></i>
                <div>
                    <div class="user-name" id="userName">Cargando...</div>
                    <div class="user-role">Supervisor</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2>Reprogramaciones Recibidas</h2>
            <p>Completa la fecha y observaci√≥n para cada registro</p>
        </div>

        <div class="alert alert-success" id="successAlert">
            <i class="fas fa-check-circle"></i>
            <span id="successMsg"></span>
        </div>

        <div class="alert alert-error" id="errorAlert">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMsg"></span>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="pendientes">
                <i class="fas fa-clock"></i>
                Pendientes
                <span class="tab-badge" id="pendingBadge">0</span>
            </button>
            <button class="tab" data-tab="respondidas">
                <i class="fas fa-check-circle"></i>
                Respondidas
            </button>
            <button class="tab" data-tab="todas">
                <i class="fas fa-list"></i>
                Todas
            </button>
        </div>

        <div class="loader active" id="loader">
            <div class="spinner"></div>
            <div style="color: #9ca3af; font-size: 13px;">Cargando reprogramaciones...</div>
        </div>

        <div id="reprogContainer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, get, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Prevenir zoom en double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Monitorear estado de conexi√≥n
        window.addEventListener('online', () => {
            document.getElementById('offlineBanner').classList.remove('show');
        });

        window.addEventListener('offline', () => {
            document.getElementById('offlineBanner').classList.add('show');
        });

        // Prevenir comportamiento de arrastrar para recargar (pull to refresh nativo)
        document.body.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        const firebaseConfig = {
            apiKey: "AIzaSyBDRqsZI8EQaGn1lCc4Y5rIcfmLE7969zY",
            authDomain: "reprogramacionesme.firebaseapp.com",
            databaseURL: "https://reprogramacionesme-default-rtdb.firebaseio.com",
            projectId: "reprogramacionesme",
            storageBucket: "reprogramacionesme.firebasestorage.app",
            messagingSenderId: "674035461204",
            appId: "1:674035461204:web:a70b7793f71ae1c5e311c1",
            measurementId: "G-T4VJ4EQKNT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let userData = null;
        let todasReprogramaciones = [];
        let tabActual = 'pendientes';
        let datosEditados = {};

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('‚úÖ Usuario autenticado:', user.email);
                console.log('üÜî UID:', user.uid);
                currentUser = user;
                
                try {
                    console.log('üì• Cargando datos del usuario...');
                    await cargarDatosUsuario();
                    
                    console.log('üìã Cargando reprogramaciones...');
                    cargarReprogramaciones();
                } catch (error) {
                    console.error('‚ùå Error en la inicializaci√≥n:', error);
                    if (error.code === 'PERMISSION_DENIED' || error.message?.includes('Permission denied')) {
                        mostrarAlerta('error', '‚ö†Ô∏è Error de permisos. Verifica las reglas de Firebase.');
                    } else {
                        mostrarAlerta('error', 'Error al cargar datos: ' + error.message);
                    }
                }
            } else {
                console.log('‚ùå Usuario no autenticado');
                window.location.href = 'login.html';
            }
        });

        async function cargarDatosUsuario() {
            try {
                console.log('üîç Consultando datos del usuario...');
                const userRef = ref(db, `usuarios/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    console.log('‚úÖ Datos cargados:', userData);
                    console.log('üë§ Nombre:', userData.nombre);
                    console.log('üé≠ Rol:', userData.rol);
                    document.getElementById('userName').textContent = userData.nombre;
                    
                    if (userData.rol !== 'supervisor') {
                        console.warn('‚ö†Ô∏è Este usuario NO es supervisor, es:', userData.rol);
                        mostrarAlerta('error', 'Tu usuario no tiene rol de supervisor');
                    }
                } else {
                    console.error('‚ùå No se encontraron datos para este usuario');
                    mostrarAlerta('error', 'Usuario no encontrado en la base de datos');
                }
            } catch (error) {
                console.error('‚ùå Error al cargar usuario:', error);
                throw error;
            }
        }

        let paginaActual = 1;
        const ITEMS_POR_PAGINA = 10;
        
        async function cargarReprogramaciones() {
            console.log('üì• Cargando reprogramaciones del supervisor...');
            const loader = document.getElementById('loader');
            
            try {
                const meses = obtenerUltimosMeses(3);
                console.log('üìÖ Consultando meses:', meses);
                
                // Cargar todos los meses en paralelo (optimizaci√≥n)
                const promesas = meses.map(async mes => {
                    const reprogRef = ref(db, `reprogramaciones/${mes}`);
                    const snapshot = await get(reprogRef);

                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const misSupervisiones = [];
                        
                        Object.entries(data).forEach(([id, reprog]) => {
                            // Filtrar solo las del supervisor actual
                            if (reprog.supervisorId === currentUser.uid) {
                                misSupervisiones.push({ id, mes, ...reprog });
                            }
                        });
                        
                        return misSupervisiones;
                    }
                    return [];
                });

                const resultados = await Promise.all(promesas);
                todasReprogramaciones = [];
                resultados.forEach(reprogs => todasReprogramaciones.push(...reprogs));
                
                // Ordenar por fecha m√°s reciente
                todasReprogramaciones.sort((a, b) => new Date(b.fechaSubida) - new Date(a.fechaSubida));
                
                console.log(`‚úÖ ${todasReprogramaciones.length} reprogramaciones encontradas para este supervisor`);
                
                loader.classList.remove('active');
                actualizarEstadisticas();
                mostrarReprogramaciones();
                
            } catch (error) {
                console.error('‚ùå Error al cargar reprogramaciones:', error);
                loader.classList.remove('active');
                
                if (error.code === 'PERMISSION_DENIED') {
                    mostrarAlerta('error', '‚ö†Ô∏è Error de permisos. Verifica las reglas de Firebase.');
                } else {
                    mostrarAlerta('error', 'Error al cargar: ' + error.message);
                }
                
                document.getElementById('reprogContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i></div>
                        <div class="empty-text" style="color: #ef4444;">Error al cargar datos</div>
                    </div>
                `;
            }
        }

        function actualizarEstadisticas() {
            const pendientes = todasReprogramaciones.filter(r => r.estado === 'pendiente').length;
            const respondidas = todasReprogramaciones.filter(r => r.estado === 'respondida').length;
            
            document.getElementById('pendingCount').textContent = pendientes;
            document.getElementById('answeredCount').textContent = respondidas;
            document.getElementById('pendingBadge').textContent = pendientes;
        }

        function mostrarReprogramaciones() {
            let filtradas = todasReprogramaciones;
            
            // Aplicar filtro de tab
            if (tabActual === 'pendientes') {
                filtradas = todasReprogramaciones.filter(r => r.estado === 'pendiente');
            } else if (tabActual === 'respondidas') {
                filtradas = todasReprogramaciones.filter(r => r.estado === 'respondida');
            }

            const container = document.getElementById('reprogContainer');
            
            if (filtradas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state fade-in">
                        <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                        <div class="empty-text">No hay reprogramaciones ${tabActual}</div>
                    </div>
                `;
                return;
            }

            // Paginaci√≥n: mostrar solo ITEMS_POR_PAGINA
            const inicio = 0;
            const fin = ITEMS_POR_PAGINA;
            const reprogsPagina = filtradas.slice(inicio, fin);
            
            console.log(`üìÑ Mostrando ${reprogsPagina.length} de ${filtradas.length} reprogramaciones (p√°gina 1)`);
            
            let html = reprogsPagina.map(reprog => crearCardReprog(reprog)).join('');
            
            // Agregar paginaci√≥n si hay m√°s items
            if (filtradas.length > ITEMS_POR_PAGINA) {
                html += `
                    <div style="text-align: center; padding: 24px; background: white; border-radius: 16px; margin-top: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                            Mostrando ${reprogsPagina.length} de ${filtradas.length} reprogramaciones
                        </p>
                        <button class="btn btn-primary" onclick="cargarMasSupervisiones()" id="btnCargarMas">
                            <i class="fas fa-chevron-down"></i>
                            Cargar m√°s (${filtradas.length - ITEMS_POR_PAGINA} restantes)
                        </button>
                    </div>
                `;
                
                // Guardar filtradas en variable global para paginaci√≥n
                window.reprogramacionesFiltradas = filtradas;
                paginaActual = 1;
            }
            
            container.innerHTML = html;
            // A√±adir animaci√≥n
            container.classList.add('fade-in');
        }
        
        window.cargarMasSupervisiones = function() {
            if (!window.reprogramacionesFiltradas) return;
            
            paginaActual++;
            const inicio = paginaActual * ITEMS_POR_PAGINA;
            const fin = inicio + ITEMS_POR_PAGINA;
            const siguientePagina = window.reprogramacionesFiltradas.slice(inicio, fin);
            
            if (siguientePagina.length === 0) return;
            
            console.log(`üìÑ Cargando p√°gina ${paginaActual + 1}: ${siguientePagina.length} items`);
            
            const container = document.getElementById('reprogContainer');
            const paginacionDiv = container.querySelector('[id="btnCargarMas"]')?.parentElement;
            
            // Remover div de paginaci√≥n anterior
            if (paginacionDiv) paginacionDiv.remove();
            
            // Agregar nuevos items
            const htmlNuevos = siguientePagina.map(reprog => crearCardReprog(reprog)).join('');
            container.innerHTML += htmlNuevos;
            
            // Agregar nueva paginaci√≥n si quedan m√°s
            const totalMostrados = (paginaActual + 1) * ITEMS_POR_PAGINA;
            const restantes = window.reprogramacionesFiltradas.length - totalMostrados;
            
            if (restantes > 0) {
                container.innerHTML += `
                    <div style="text-align: center; padding: 24px; background: white; border-radius: 16px; margin-top: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                            Mostrando ${totalMostrados} de ${window.reprogramacionesFiltradas.length} reprogramaciones
                        </p>
                        <button class="btn btn-primary" onclick="cargarMasSupervisiones()" id="btnCargarMas">
                            <i class="fas fa-chevron-down"></i>
                            Cargar m√°s (${restantes} restantes)
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML += `
                    <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 14px;">
                        <i class="fas fa-check-circle"></i> Todas las reprogramaciones cargadas
                    </div>
                `;
            }
        }

        function convertirFechaExcel(serial) {
            if (!serial || typeof serial !== 'number') return serial;
            
            // Excel cuenta los d√≠as desde 1900-01-01
            const fechaBase = new Date(1900, 0, 1);
            const dias = serial - 2; // Ajuste por el bug de 1900 en Excel
            const fecha = new Date(fechaBase.getTime() + dias * 24 * 60 * 60 * 1000);
            
            const dia = fecha.getDate();
            const mes = fecha.getMonth() + 1;
            const anio = fecha.getFullYear();
            
            return `${dia}/${mes}/${anio}`;
        }

        function crearCardReprog(reprog) {
            const fecha = new Date(reprog.fechaSubida).toLocaleString('es-CO');
            const estadoClass = reprog.estado === 'respondida' ? 'badge-answered' : 'badge-pending';
            const estadoTexto = reprog.estado === 'respondida' ? 'Respondida' : 'Pendiente';
            const estadoIcon = reprog.estado === 'respondida' ? 'fa-check-circle' : 'fa-clock';

            const datosExcel = reprog.datosExcel || [];
            const totalRegistros = datosExcel.length;
            
            // Inicializar datos editados solo si es pendiente
            if (!datosEditados[reprog.id] && reprog.estado === 'pendiente') {
                datosEditados[reprog.id] = datosExcel.map(row => ({
                    ...row,
                    'FECHA REPROGRAMACION': row['FECHA REPROGRAMACION'] || '',
                    'OBSERVACION': row['OBSERVACION'] || ''
                }));
            }

            let tableHTML = '';
            
            if (reprog.estado === 'pendiente' && totalRegistros > 0) {
                // Renderizar solo las primeras 50 filas (optimizaci√≥n)
                const MAX_FILAS_INICIAL = 50;
                const datosARenderizar = datosEditados[reprog.id].slice(0, MAX_FILAS_INICIAL);
                const hayMasFilas = totalRegistros > MAX_FILAS_INICIAL;
                
                tableHTML = `
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        Completa la FECHA REPROGRAMACION y OBSERVACION para cada fila y guarda los cambios
                        ${hayMasFilas ? `<br><strong>Mostrando primeras ${MAX_FILAS_INICIAL} de ${totalRegistros} filas</strong>` : ''}
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="tabla-${reprog.id}">
                            <thead>
                                <tr>
                                    <th>FECHA REPROG.</th>
                                    <th>OBSERVACI√ìN</th>
                                    <th>AID PROMOTOR</th>
                                    <th>ID PV</th>
                                    <th>NOMBRE PROMOTOR</th>
                                    <th>PUNTO DE VENTA</th>
                                    <th>FECHA</th>
                                    <th>ZONA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datosARenderizar.map((row, index) => `
                                    <tr>
                                        <td class="editable-cell">
                                            <input 
                                                type="date" 
                                                data-reprog="${reprog.id}" 
                                                data-row="${index}" 
                                                data-field="FECHA REPROGRAMACION"
                                                value="${row['FECHA REPROGRAMACION'] || ''}"
                                                onchange="actualizarCelda(this)"
                                            >
                                        </td>
                                        <td class="editable-cell">
                                            <textarea 
                                                data-reprog="${reprog.id}" 
                                                data-row="${index}" 
                                                data-field="OBSERVACION"
                                                onchange="actualizarCelda(this)"
                                                placeholder="Escribe observaci√≥n..."
                                            >${row['OBSERVACION'] || ''}</textarea>
                                        </td>
                                        <td>${row['AID PROMOTOR'] || ''}</td>
                                        <td>${row['ID PV'] || ''}</td>
                                        <td>${row['NOMBRE PROMOTOR'] || ''}</td>
                                        <td>${row['NOMBRE PUNTO DE VENTA'] || ''}</td>
                                        <td>${convertirFechaExcel(row['FECHA']) || row['FECHA'] || ''}</td>
                                        <td>${row['ZONA'] || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${hayMasFilas ? `
                            <div style="text-align: center; padding: 16px; background: #fffbeb; border-top: 1px solid #fcd34d; border-radius: 0 0 8px 8px;">
                                <button class="btn btn-primary" onclick="cargarMasFilas('${reprog.id}', ${MAX_FILAS_INICIAL})" style="max-width: 300px;">
                                    <i class="fas fa-chevron-down"></i>
                                    Ver todas las filas (${totalRegistros - MAX_FILAS_INICIAL} m√°s)
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="actions-bar">
                        <button class="btn btn-success" onclick="guardarRespuestas('${reprog.mes}', '${reprog.id}')">
                            <i class="fas fa-save"></i>
                            Guardar y Marcar como Respondida
                        </button>
                    </div>
                `;
            } else if (reprog.estado === 'respondida' && totalRegistros > 0) {
                // Vista de solo lectura - tambi√©n limitada
                const MAX_FILAS_VISTA = 50;
                const datosVista = datosExcel.slice(0, MAX_FILAS_VISTA);
                const hayMas = totalRegistros > MAX_FILAS_VISTA;
                
                tableHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>FECHA REPROG.</th>
                                    <th>OBSERVACI√ìN</th>
                                    <th>AID PROMOTOR</th>
                                    <th>ID PV</th>
                                    <th>NOMBRE PROMOTOR</th>
                                    <th>PUNTO DE VENTA</th>
                                    <th>FECHA</th>
                                    <th>ZONA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datosVista.map(row => `
                                    <tr>
                                        <td style="font-weight: 600; color: #059669;">${row['FECHA REPROGRAMACION'] || '-'}</td>
                                        <td style="max-width: 200px; white-space: normal;">${row['OBSERVACION'] || '-'}</td>
                                        <td>${row['AID PROMOTOR'] || ''}</td>
                                        <td>${row['ID PV'] || ''}</td>
                                        <td>${row['NOMBRE PROMOTOR'] || ''}</td>
                                        <td>${row['NOMBRE PUNTO DE VENTA'] || ''}</td>
                                        <td>${convertirFechaExcel(row['FECHA']) || row['FECHA'] || ''}</td>
                                        <td>${row['ZONA'] || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${hayMas ? `
                            <div style="text-align: center; padding: 16px; background: #f0fdf4; border-top: 1px solid #86efac; border-radius: 0 0 8px 8px;">
                                <p style="color: #166534; font-size: 13px;">
                                    <i class="fas fa-info-circle"></i>
                                    Mostrando primeras ${MAX_FILAS_VISTA} de ${totalRegistros} filas
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="reprog-card fade-in">
                    <div class="card-header">
                        <div class="card-info">
                            <h3>De: ${reprog.auxiliarNombre}</h3>
                            <div class="card-meta">
                                <div class="meta-item">
                                    <i class="far fa-calendar"></i>
                                    ${new Date(fecha).toLocaleDateString('es-CO')}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-list-ol"></i>
                                    ${totalRegistros} registros
                                </div>
                            </div>
                        </div>
                        <span class="status-badge ${estadoClass}">
                            <i class="fas ${estadoIcon}"></i>
                            ${estadoTexto}
                        </span>
                    </div>
                    ${tableHTML}
                </div>
            `;
        }
        
        // Funci√≥n para cargar m√°s filas en tablas grandes
        window.cargarMasFilas = function(reprogId, filasMostradas) {
            const datosCompletos = datosEditados[reprogId];
            if (!datosCompletos) return;
            
            const tabla = document.getElementById('tabla-' + reprogId);
            if (!tabla) return;
            
            const tbody = tabla.querySelector('tbody');
            const siguientes50 = datosCompletos.slice(filasMostradas, filasMostradas + 50);
            
            siguientes50.forEach((row, i) => {
                const index = filasMostradas + i;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="editable-cell">
                        <input 
                            type="date" 
                            data-reprog="${reprogId}" 
                            data-row="${index}" 
                            data-field="FECHA REPROGRAMACION"
                            value="${row['FECHA REPROGRAMACION'] || ''}"
                            onchange="actualizarCelda(this)"
                        >
                    </td>
                    <td class="editable-cell">
                        <textarea 
                            data-reprog="${reprogId}" 
                            data-row="${index}" 
                            data-field="OBSERVACION"
                            onchange="actualizarCelda(this)"
                        >${row['OBSERVACION'] || ''}</textarea>
                    </td>
                    <td>${row['AID PROMOTOR'] || ''}</td>
                    <td>${row['ID PV'] || ''}</td>
                    <td>${row['ID EMPRESA'] || ''}</td>
                    <td>${row['N_DIA'] || ''}</td>
                    <td>${convertirFechaExcel(row['FECHA']) || row['FECHA'] || ''}</td>
                    <td>${row['MINUTOS'] || ''}</td>
                    <td>${row['HORAS'] || ''}</td>
                    <td>${row['NOMBRE PROMOTOR'] || ''}</td>
                    <td>${row['NOMBRE PUNTO DE VENTA'] || ''}</td>
                    <td>${row['NOMBRE EMPRESA'] || ''}</td>
                    <td>${row['CIUDAD PV'] || ''}</td>
                    <td>${row['DEPARTAMENTO PV'] || ''}</td>
                    <td>${row['ZONA'] || ''}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Actualizar o remover bot√≥n
            const btnContainer = tabla.parentElement.querySelector('[style*="background: #fffbeb"]');
            if (btnContainer) {
                const nuevoTotal = filasMostradas + 50;
                if (nuevoTotal >= datosCompletos.length) {
                    btnContainer.remove();
                } else {
                    const btn = btnContainer.querySelector('button');
                    btn.onclick = () => cargarMasFilas(reprogId, nuevoTotal);
                    btn.innerHTML = `
                        <i class="fas fa-chevron-down"></i>
                        Ver m√°s filas (${datosCompletos.length - nuevoTotal} restantes)
                    `;
                }
            }
        }

        window.actualizarCelda = function(input) {
            const reprogId = input.dataset.reprog;
            const rowIndex = parseInt(input.dataset.row);
            const field = input.dataset.field;
            const value = input.value;

            if (datosEditados[reprogId]) {
                datosEditados[reprogId][rowIndex][field] = value;
                // Feedback visual mejorado
                input.style.borderColor = '#10b981';
                input.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
                
                // Vibraci√≥n t√°ctil si est√° disponible
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
                
                setTimeout(() => {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                }, 1000);
            } else {
                console.error('‚ùå No se encontr√≥ reprogramaci√≥n:', reprogId);
            }
        };

        window.guardarRespuestas = async function(mes, id) {
            console.log('üíæ Intentando guardar:', { mes, id });
            
            const datosActualizados = datosEditados[id];
            
            if (!datosActualizados) {
                console.error('‚ùå No hay datos para ID:', id);
                mostrarAlerta('error', 'No hay datos para guardar. Recarga la p√°gina e intenta de nuevo.');
                return;
            }

            console.log('‚úÖ Datos encontrados:', datosActualizados.length, 'filas');
            const todasCompletas = datosActualizados.every(row => 
                row['FECHA REPROGRAMACION'] && row['OBSERVACION']
            );

            if (!todasCompletas) {
                if (!confirm('‚ö†Ô∏è Algunas filas no tienen fecha u observaci√≥n.\n\n¬øDeseas continuar de todos modos?')) {
                    return;
                }
            }

            // Mostrar indicador de carga
            const btnGuardar = event.target;
            const textoOriginal = btnGuardar.innerHTML;
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const reprogRef = ref(db, `reprogramaciones/${mes}/${id}`);
                const fechaRespuesta = new Date().toISOString();
                
                await update(reprogRef, {
                    estado: 'respondida',
                    datosExcel: datosActualizados,
                    fechaRespuesta: fechaRespuesta
                });

                // Vibraci√≥n de √©xito
                if (navigator.vibrate) {
                    navigator.vibrate([50, 100, 50]);
                }

                mostrarAlerta('success', '‚úì Reprogramaci√≥n completada exitosamente');
                delete datosEditados[id];
                
                // üìß Enviar correo a la auxiliar
                try {
                    const reprog = todasReprogramaciones.find(r => r.id === id && r.mes === mes);
                    if (reprog) {
                        const auxSnap = await get(ref(db, `usuarios/${reprog.auxiliarId}`));
                        if (auxSnap.exists()) {
                            await notificarAuxiliarReprogramacionCompletada({
                                auxiliarEmail: auxSnap.val().email,
                                auxiliarNombre: auxSnap.val().nombre,
                                supervisorNombre: userData.nombre,
                                archivoNombre: reprog.archivoNombre,
                                totalRegistros: reprog.totalRegistros,
                                fechaRespuesta: fechaRespuesta
                            });
                        }
                    }
                } catch (e) { console.warn('‚ö†Ô∏è Error email:', e); }
                
                // üîÑ RECARGAR LISTA AUTOM√ÅTICAMENTE
                console.log('üîÑ Recargando lista de reprogramaciones...');
                setTimeout(async () => {
                    await cargarReprogramaciones();
                    // Cambiar a pesta√±a de respondidas para ver el cambio
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('[data-tab="respondidas"]').classList.add('active');
                    tabActual = 'respondidas';
                    mostrarReprogramaciones();
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('error', 'Error al guardar: ' + error.message);
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = textoOriginal;
                
                // Vibraci√≥n de error
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                }
            }
        };

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                tabActual = this.dataset.tab;
                mostrarReprogramaciones();
            });
        });

        window.cerrarSesion = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error:', error);
            }
        };

        function obtenerUltimosMeses(cantidad) {
            const meses = [];
            const ahora = new Date();
            for (let i = 0; i < cantidad; i++) {
                const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
                const mes = fecha.toISOString().slice(0, 7).replace('-', '');
                meses.push(mes);
            }
            return meses;
        }

        function mostrarAlerta(tipo, mensaje) {
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            
            if (tipo === 'success') {
                document.getElementById('successMsg').textContent = mensaje;
                successAlert.classList.add('show');
                setTimeout(() => successAlert.classList.remove('show'), 5000);
            } else {
                document.getElementById('errorMsg').textContent = mensaje;
                errorAlert.classList.add('show');
                setTimeout(() => errorAlert.classList.remove('show'), 5000);
            }
            
            // Vibraci√≥n para alertas
            if (navigator.vibrate) {
                navigator.vibrate(tipo === 'success' ? [50, 50, 50] : [100, 50, 100]);
            }
            
            // Scroll suave a la alerta
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Optimizaci√≥n: Lazy loading de im√°genes (si agregas en el futuro)
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        imageObserver.unobserve(img);
                    }
                });
            });
        }

        // Compatibilidad con Android WebView
        if (typeof Android !== 'undefined') {
            console.log('‚úÖ Ejecutando en WebView de Android');
            
            // Funciones de puente con Android (si las necesitas)
            window.notificarAndroid = function(mensaje) {
                try {
                    if (Android.mostrarToast) {
                        Android.mostrarToast(mensaje);
                    }
                } catch (e) {
                    console.log('No se puede comunicar con Android:', e);
                }
            };
        }
    </script>
</body>
</html>
