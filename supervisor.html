<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#8b5cf6">
    <title>Supervisi√≥n App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            overflow: hidden;
        }

        /* --- HEADER ESTILO APP --- */
        .header {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 16px 20px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-brand {
            display: flex;
            flex-direction: column;
        }

        .app-title {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .supervisor-name {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            backdrop-filter: blur(4px);
        }

        /* --- STATS CARDS (Mini Dashboard) --- */
        .header-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-number {
            font-size: 20px;
            font-weight: 800;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 2px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.pending .stat-number { color: #fcd34d; }
        .stat-card.warning .stat-number { color: #fdba74; }
        .stat-card.offline .stat-number { color: #fca5a5; }

        /* --- FILTROS SUPERIORES (Pills) --- */
        .filter-scroller {
            background: var(--bg-primary);
            padding: 12px 16px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-scroller::-webkit-scrollbar { display: none; }

        .filter-pill {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .filter-pill.active {
            background: var(--text-primary);
            color: white;
            border-color: var(--text-primary);
        }

        .pill-badge {
            background: rgba(0,0,0,0.1);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        .filter-pill.active .pill-badge { background: rgba(255,255,255,0.2); }

        /* --- CONTENT AREA --- */
        .main-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 16px 80px 16px;
            position: relative;
        }

        /* --- SEGMENTED CONTROL (Estilo iOS) --- */
        .app-segment-container {
            background: #e2e8f0;
            border-radius: 14px;
            padding: 4px;
            display: flex;
            margin-bottom: 20px;
            position: sticky; /* Sticky dentro del contenedor */
            top: 0;
            z-index: 90;
        }

        .segment-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 8px;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s ease;
            position: relative;
        }

        .segment-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 700;
        }

        .segment-btn i {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .segment-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .segment-btn.active .segment-badge {
            border-color: white;
        }

        .segment-desc {
            font-size: 10px;
            opacity: 0.7;
            font-weight: 400;
            display: none;
        }
        @media (min-width: 380px) {
            .segment-desc { display: block; }
        }

        /* --- CARDS & TABLES --- */
        .reprog-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }

        .reprog-card.tipo-reprogramaciones { border-left: 4px solid #3b82f6; }
        .reprog-card.tipo-pendientes { border-left: 4px solid #f59e0b; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-pending { background: #fff7ed; color: #c2410c; }
        .badge-answered { background: #f0fdf4; color: #15803d; }

        /* Tablas Responsive */
        .table-wrapper {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            margin-top: 12px;
            background: white;
        }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
        }

        .editable-cell input, .editable-cell textarea {
            width: 100%;
            min-width: 150px;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
            min-height: 44px;
            background: white;
        }
        
        .editable-cell textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .editable-cell input:focus, .editable-cell textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            margin-top: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }

        /* Estados */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state i { font-size: 40px; margin-bottom: 12px; opacity: 0.3; }
        
        /* Banner de conexi√≥n */
        .connection-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }
        .connection-banner.show { transform: translateY(0); }
        .connection-banner.online { background: var(--success); }
        .connection-banner.offline { background: var(--error); }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .loader.active { display: flex; }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Alertas */
        .alert-toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 5px solid var(--primary);
        }
        .alert-toast.show { transform: translateY(0); }
        .alert-toast.success { border-color: var(--success); }
        .alert-toast.error { border-color: var(--error); }
        
        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-card {
            background: white;
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        .modal-overlay.show .modal-card { transform: scale(1); }
    </style>
</head>
<body>

<div class="connection-banner" id="connectionBanner">
    <span id="connectionText">Conectado</span>
</div>

<header class="header">
    <div class="header-top">
        <div class="header-brand">
            <div class="app-title">
                <i class="fas fa-cube"></i> Supervisi√≥n
            </div>
            <div class="supervisor-name" id="supervisorName">Cargando...</div>
        </div>
        <button class="logout-btn" onclick="cerrarSesion()">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>

    <div class="header-stats">
        <div class="stat-card pending">
            <span class="stat-number" id="reprogCount">0</span>
            <span class="stat-label">Reprog.</span>
        </div>
        <div class="stat-card warning">
            <span class="stat-number" id="pendingCount">0</span>
            <span class="stat-label">Pendientes</span>
        </div>
        <div class="stat-card offline">
            <span class="stat-number" id="offlineCount">0</span>
            <span class="stat-label">Offline</span>
        </div>
    </div>
</header>

<div class="filter-scroller">
    <button class="filter-pill active" data-tab="pendientes" onclick="cambiarTab('pendientes')">
        Pendientes
        <span class="pill-badge" id="pendingBadge">0</span>
    </button>
    <button class="filter-pill" data-tab="respondidas" onclick="cambiarTab('respondidas')">
        Respondidas
    </button>
    <button class="filter-pill" data-tab="todas" onclick="cambiarTab('todas')">
        Todas
    </button>
</div>

<div class="main-container">
    
    <div class="sync-status" id="syncStatus" style="display:none; background:#fffbeb; color:#92400e; padding:10px; border-radius:8px; margin:10px 0; font-size:13px; align-items:center; gap:8px;">
        <i class="fas fa-sync fa-spin"></i>
        <div>
            <strong id="syncTitle">Sincronizando...</strong>
            <span id="syncDesc" style="font-size:11px; display:block;">Guardando datos</span>
        </div>
    </div>
    
    <div class="loader active" id="loader">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-size:13px; color:#64748b;">Cargando datos...</div>
    </div>

    <div class="app-segment-container">
        <button class="segment-btn tab-btn" data-tab="reprogramaciones">
            <div style="position:relative">
                <i class="fas fa-clipboard-list"></i>
                <span id="reprogBadge" class="segment-badge" style="display:none;">0</span>
            </div>
            <span>Reprogramaciones</span>
            <span class="segment-desc">Visitas a reprogramar</span>
        </button>
        
        <button class="segment-btn tab-btn active" data-tab="pendientes">
            <div style="position:relative">
                <i class="fas fa-clock"></i>
                <span id="pendientesBadge" class="segment-badge" style="display:none;">0</span>
            </div>
            <span>Pendientes</span>
            <span class="segment-desc">Tareas generales</span>
        </button>
    </div>

    <div class="tab-content-area">
        <div class="tab-pane" id="reprogramaciones-tab">
            <div id="reprogContainer"></div>
        </div>
        <div class="tab-pane active" id="pendientes-tab">
            <div id="pendientesContainer"></div>
        </div>
    </div>
</div>

<div class="alert-toast" id="mainToast">
    <div id="toastIcon"></div>
    <div id="toastMsg" style="font-size:14px; font-weight:500;">Mensaje</div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-card">
        <div class="modal-icon" style="font-size:32px; margin-bottom:16px;">‚ö†Ô∏è</div>
        <h3 id="modalTitle" style="margin-bottom:8px; font-size:18px;">T√≠tulo</h3>
        <p id="modalMessage" style="color:#64748b; font-size:14px; margin-bottom:20px; line-height:1.5;">Mensaje</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button id="modalCancel" style="padding:12px; border-radius:10px; border:1px solid #e2e8f0; background:white; font-weight:600;">Cancelar</button>
            <button id="modalConfirm" style="padding:12px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:600;">Aceptar</button>
        </div>
    </div>
</div>

<script src="email-service.js"></script>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, get, update, onChildAdded, onChildChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBDRqsZI8EQaGn1lCc4Y5rIcfmLE7969zY",
        authDomain: "reprogramacionesme.firebaseapp.com",
        databaseURL: "https://reprogramacionesme-default-rtdb.firebaseio.com",
        projectId: "reprogramacionesme",
        storageBucket: "reprogramacionesme.firebasestorage.app",
        messagingSenderId: "674035461204",
        appId: "1:674035461204:web:a70b7793f71ae1c5e311c1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    class OfflineStorage {
        constructor() { this.dbName = 'SupervisionOfflineDB'; this.version = 1; this.db = null; }
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, this.version);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { this.db = request.result; resolve(this.db); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('reprogramaciones')) db.createObjectStore('reprogramaciones', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('cambiosPendientes')) {
                        const store = db.createObjectStore('cambiosPendientes', { keyPath: 'timestamp' });
                        store.createIndex('reprogId', 'reprogId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('usuario')) db.createObjectStore('usuario', { keyPath: 'uid' });
                };
            });
        }
        async guardarReprogramaciones(reprogs) {
            const tx = this.db.transaction(['reprogramaciones'], 'readwrite');
            const store = tx.objectStore('reprogramaciones');
            for (const reprog of reprogs) await store.put(reprog);
            return tx.complete;
        }
        async obtenerReprogramaciones() {
            if (!this.db) return [];
            const tx = this.db.transaction(['reprogramaciones'], 'readonly');
            return new Promise(resolve => {
                const req = tx.objectStore('reprogramaciones').getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            });
        }
        async guardarCambioPendiente(reprogId, mes, datos, tipo = 'reprogramaciones', nombreHoja = '') {
            const tx = this.db.transaction(['cambiosPendientes'], 'readwrite');
            const cambio = { timestamp: Date.now(), reprogId, mes, datos, tipo, nombreHoja, sincronizado: false };
            await tx.objectStore('cambiosPendientes').put(cambio);
            return cambio;
        }
        async obtenerCambiosPendientes() {
            if (!this.db) return [];
            const tx = this.db.transaction(['cambiosPendientes'], 'readonly');
            return new Promise(resolve => {
                const req = tx.objectStore('cambiosPendientes').getAll();
                req.onsuccess = () => resolve((req.result || []).filter(c => !c.sincronizado));
            });
        }
        async marcarCambioSincronizado(timestamp) {
            if (!this.db) return;
            await this.db.transaction(['cambiosPendientes'], 'readwrite').objectStore('cambiosPendientes').delete(timestamp);
        }
        async guardarUsuario(u) { if(this.db) await this.db.transaction(['usuario'], 'readwrite').objectStore('usuario').put(u); }
        async obtenerUsuario(uid) {
            if(!this.db) return null;
            return new Promise(resolve => {
                const req = this.db.transaction(['usuario'], 'readonly').objectStore('usuario').get(uid);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }
    }

    async function obtenerTodasLasAuxiliares() {
        const snapshot = await get(ref(db, 'usuarios'));
        if (!snapshot.exists()) return [];
        return Object.entries(snapshot.val()).filter(([_,d])=>d.rol==='auxiliar').map(([uid,d])=>({uid, nombre:d.nombre, email:d.email}));
    }

    const offlineStorage = new OfflineStorage();
    let isOnline = navigator.onLine, currentUser = null, userData = null;
    let todasReprogramaciones = [], tabActual = 'pendientes', datosEditados = {}, reprogramacionesIds = new Set();
    let primeraCargar = true, dbReady = false;
    let tabActiva = 'pendientes'; 

    // Inner Tabs Logic (Segmented Control)
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            tabActiva = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        });
    });

    // Outer Filters Logic (Pills)
    window.cambiarTab = function(nuevoTab) {
        tabActual = nuevoTab;
        document.querySelectorAll('.filter-pill').forEach(t => {
            t.classList.remove('active');
            if (t.dataset.tab === nuevoTab) t.classList.add('active');
        });
        mostrarReprogramaciones(); // Re-renderizar con filtro
    };

    const connectionBanner = document.getElementById('connectionBanner');
    const connectionText = document.getElementById('connectionText');
    function mostrarEstadoConexion(online) {
        isOnline = online;
        if (online) {
            connectionBanner.className = 'connection-banner online show';
            connectionText.innerHTML = '<i class="fas fa-wifi"></i> Conexi√≥n recuperada';
            setTimeout(() => connectionBanner.classList.remove('show'), 3000);
            if (dbReady) sincronizarCambiosPendientes();
        } else {
            connectionBanner.className = 'connection-banner offline show';
            connectionText.innerHTML = '<i class="fas fa-wifi-slash"></i> Modo sin conexi√≥n';
        }
    }
    window.addEventListener('online', () => mostrarEstadoConexion(true));
    window.addEventListener('offline', () => mostrarEstadoConexion(false));

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            try {
                await offlineStorage.init();
                dbReady = true;
                await cargarDatosUsuario();
                await cargarReprogramaciones();
                iniciarEscuchaNuevasReprogramaciones();
                actualizarContadorOffline((await offlineStorage.obtenerCambiosPendientes()).length);
            } catch (error) { mostrarAlerta('error', error.message); }
        } else { window.location.href = 'login.html'; }
    });

    async function cargarDatosUsuario() {
        try {
            const el = document.getElementById('supervisorName');
            const cached = await offlineStorage.obtenerUsuario(currentUser.uid);
            if (cached?.nombre) { userData = cached; el.textContent = userData.nombre; }
            if (isOnline) {
                const snap = await get(ref(db, `usuarios/${currentUser.uid}`));
                if (snap.exists()) {
                    userData = snap.val();
                    const nombre = userData.nombre || currentUser.displayName || 'Supervisor';
                    el.textContent = nombre;
                    await offlineStorage.guardarUsuario({ uid: currentUser.uid, ...userData });
                }
            }
        } catch(e){ console.error(e); }
    }

    function obtenerUltimosMeses(n) {
        const m = [], d = new Date();
        for(let i=0; i<n; i++) {
            const f = new Date(d.getFullYear(), d.getMonth()-i, 1);
            m.push(f.toISOString().slice(0,7).replace('-',''));
        }
        return m;
    }

    async function cargarReprogramaciones() {
        const loader = document.getElementById('loader');
        try {
            const cached = await offlineStorage.obtenerReprogramaciones();
            if(cached.length>0) { todasReprogramaciones=cached; loader.classList.remove('active'); actualizarEstadisticas(); mostrarReprogramaciones(); }
            
            if(isOnline) {
                const meses = obtenerUltimosMeses(3);
                const promesas = meses.map(async mes => {
                    const snap = await get(ref(db, `reprogramaciones/${mes}`));
                    if(!snap.exists()) return [];
                    return Object.entries(snap.val())
                        .filter(([_, r]) => r.supervisoresZona?.some(s => s.email === currentUser.email))
                        .map(([id, r]) => ({id, mes, ...r}));
                });
                const res = await Promise.all(promesas);
                todasReprogramaciones = res.flat().sort((a,b)=> new Date(b.fechaSubida)-new Date(a.fechaSubida));
                await offlineStorage.guardarReprogramaciones(todasReprogramaciones);
                loader.classList.remove('active');
                actualizarEstadisticas();
                mostrarReprogramaciones();
                reprogramacionesIds = new Set(todasReprogramaciones.map(r=>r.id));
                primeraCargar = false;
            }
        } catch(e) { console.error(e); loader.classList.remove('active'); }
    }

    function iniciarEscuchaNuevasReprogramaciones() {
        obtenerUltimosMeses(3).forEach(mes => {
            const rRef = ref(db, `reprogramaciones/${mes}`);
            onChildAdded(rRef, (snap) => {
                if(primeraCargar) return;
                const val = snap.val();
                if(val?.supervisoresZona?.some(s=>s.email===currentUser.email) && !reprogramacionesIds.has(snap.key)){
                    reprogramacionesIds.add(snap.key);
                    todasReprogramaciones.unshift({id:snap.key, mes, ...val});
                    offlineStorage.guardarReprogramaciones(todasReprogramaciones);
                    actualizarEstadisticas();
                    mostrarReprogramaciones();
                    mostrarAlerta('success', `Nueva asignaci√≥n de ${val.auxiliarNombre}`);
                }
            }, (error) => {
                // Suprimir errores 403 iniciales (permisos durante carga)
                if(error.code !== 'PERMISSION_DENIED') console.error('Error listener:', error);
            });
            onChildChanged(rRef, (snap) => {
                const val = snap.val();
                if(val?.supervisoresZona?.some(s=>s.email===currentUser.email)) {
                    const idx = todasReprogramaciones.findIndex(r=>r.id===snap.key);
                    if(idx!==-1) {
                        todasReprogramaciones[idx] = {id:snap.key, mes, ...val};
                        offlineStorage.guardarReprogramaciones(todasReprogramaciones);
                        actualizarEstadisticas();
                        mostrarReprogramaciones();
                    }
                }
            }, (error) => {
                // Suprimir errores 403 iniciales (permisos durante carga)
                if(error.code !== 'PERMISSION_DENIED') console.error('Error listener:', error);
            });
        });
    }

    async function sincronizarCambiosPendientes() {
        const pendientes = await offlineStorage.obtenerCambiosPendientes();
        if(pendientes.length===0) return;
        const status = document.getElementById('syncStatus');
        status.style.display = 'flex';
        let sync = 0;
        for(const c of pendientes) {
            try {
                // Determinar si es reprogramaci√≥n o pendiente basado en los datos guardados
                const updateData = {
                    estado: 'respondida',
                    fechaRespuesta: new Date().toISOString()
                };
                
                // Si el cambio tiene informaci√≥n sobre el tipo, usarlo
                // Si tiene nombreHoja, es una tarea pendiente
                if(c.nombreHoja) {
                    updateData[`datosPendientesPorHoja/${c.nombreHoja}`] = c.datos;
                } else if(c.tipo === 'pendientes') {
                    updateData.datosPendientes = c.datos;
                } else {
                    // Por defecto, asumir que es reprogramaci√≥n
                    updateData.datosReprogramacion = c.datos;
                }
                
                await update(ref(db, `reprogramaciones/${c.mes}/${c.reprogId}`), updateData);
                await offlineStorage.marcarCambioSincronizado(c.timestamp);
                sync++;
            } catch(e){ console.error(e); }
        }
        status.style.display = 'none';
        if(sync>0) { mostrarAlerta('success', 'Sincronizaci√≥n completada'); cargarReprogramaciones(); }
        actualizarContadorOffline((await offlineStorage.obtenerCambiosPendientes()).length);
    }

    function actualizarContadorOffline(n) { 
        document.getElementById('offlineCount').textContent = n;
        const card = document.querySelector('.stat-card.offline');
        if(n>0) card.style.background = 'rgba(239,68,68,0.2)';
        else card.style.background = 'rgba(255,255,255,0.15)';
    }

    function actualizarEstadisticas() {
        // Stats Superiores siempre muestran la carga de trabajo (Pendientes reales)
        const pendingTotal = todasReprogramaciones.filter(r => r.estado === 'pendiente');
        const rCount = pendingTotal.filter(r => r.datosReprogramacion?.length > 0).length;
        const pCount = pendingTotal.filter(r => r.datosPendientes?.length > 0).length;
        
        document.getElementById('reprogCount').textContent = rCount;
        document.getElementById('pendingCount').textContent = pCount;
        document.getElementById('pendingBadge').textContent = rCount + pCount;
    }

    function mostrarReprogramaciones() {
        // 1. FILTRADO PRINCIPAL (L√≥gica corregida)
        let itemsFiltrados = [];
        
        if (tabActual === 'pendientes') {
            // Solo mostrar las que NO han sido respondidas
            itemsFiltrados = todasReprogramaciones.filter(r => r.estado === 'pendiente');
        } else if (tabActual === 'respondidas') {
            // Solo mostrar el HISTORIAL (las ya respondidas)
            itemsFiltrados = todasReprogramaciones.filter(r => r.estado === 'respondida');
        } else {
            // Tab 'Todas': mostrar todo
            itemsFiltrados = todasReprogramaciones;
        }

        // 2. Separar para los Tabs Internos (Reprogramaciones vs Pendientes)
        const reprogs = itemsFiltrados.filter(r => r.datosReprogramacion?.length > 0);
        
        // ‚úÖ FILTRAR PENDIENTES: Formato antiguo O nuevo
        const pends = itemsFiltrados.filter(r => {
            const tieneFormatoAntiguo = r.datosPendientes?.length > 0;
            const tieneFormatoNuevo = r.datosPendientesPorHoja && Object.keys(r.datosPendientesPorHoja).length > 0;
            return tieneFormatoAntiguo || tieneFormatoNuevo;
        });

        // Contar total de hojas de pendientes (incluyendo subdivisiones)
        let totalHojasPendientes = 0;
        pends.forEach(r => {
            if (r.datosPendientesPorHoja && Object.keys(r.datosPendientesPorHoja).length > 0) {
                totalHojasPendientes += Object.keys(r.datosPendientesPorHoja).length;
            } else if (r.datosPendientes?.length > 0) {
                totalHojasPendientes += 1; // Formato antiguo
            }
        });

        // Actualizar Badges de los Tabs Internos con la cantidad FILTRADA
        const rBadge = document.getElementById('reprogBadge');
        if(reprogs.length > 0) { rBadge.textContent = reprogs.length; rBadge.style.display = 'block'; } 
        else rBadge.style.display = 'none';

        const pBadge = document.getElementById('pendientesBadge');
        if(totalHojasPendientes > 0) { pBadge.textContent = totalHojasPendientes; pBadge.style.display = 'block'; }
        else pBadge.style.display = 'none';

        // 3. Renderizar Reprogramaciones
        const containerR = document.getElementById('reprogContainer');
        if(reprogs.length===0) {
            const msg = tabActual === 'respondidas' ? 'No hay historial de reprogramaciones' : 'No hay reprogramaciones pendientes';
            containerR.innerHTML = emptyStateHTML('clipboard-list', msg);
        } else {
            containerR.innerHTML = reprogs.map(r => crearCardReprog(r, 'reprogramaciones')).join('');
        }

        // 4. Renderizar Pendientes (Tareas) - CADA HOJA POR SEPARADO
        const containerP = document.getElementById('pendientesContainer');
        if(pends.length===0) {
            const msg = tabActual === 'respondidas' ? 'No hay historial de tareas' : 'No hay tareas pendientes';
            containerP.innerHTML = emptyStateHTML('clock', msg);
        } else {
            // Agrupar por reprogramaci√≥n y luego por hoja
            let htmlPendientes = '';
            pends.forEach(reprog => {
                // Si tiene datosPendientesPorHoja, renderizar cada hoja por separado
                if (reprog.datosPendientesPorHoja && Object.keys(reprog.datosPendientesPorHoja).length > 0) {
                    for (const [nombreHoja, datos] of Object.entries(reprog.datosPendientesPorHoja)) {
                        const reprogConHoja = { 
                            ...reprog, 
                            datosPendientes: datos, 
                            nombreHojaActual: nombreHoja 
                        };
                        htmlPendientes += crearCardReprog(reprogConHoja, 'pendientes');
                    }
                } else {
                    // Fallback: si no tiene el nuevo formato, usar el antiguo
                    htmlPendientes += crearCardReprog(reprog, 'pendientes');
                }
            });
            containerP.innerHTML = htmlPendientes;
        }
    }

    function emptyStateHTML(icon, text) {
        return `<div class="empty-state"><i class="fas fa-${icon}"></i><div>${text}</div></div>`;
    }

    function crearCardReprog(reprog, tipo) {
        const fecha = new Date(reprog.fechaSubida).toLocaleDateString('es-CO');
        const datos = tipo === 'reprogramaciones' ? (reprog.datosReprogramacion||[]) : (reprog.datosPendientes||[]);
        const estadoClass = reprog.estado==='respondida'?'badge-answered':'badge-pending';
        
        // Crear ID √∫nico para cada hoja (importante cuando hay m√∫ltiples hojas)
        const edicionId = reprog.nombreHojaActual ? `${reprog.id}_${reprog.nombreHojaActual}` : reprog.id;
        
        // Init cache edicion solo si est√° pendiente
        if (!datosEditados[edicionId] && reprog.estado === 'pendiente') {
            datosEditados[edicionId] = datos.map(row => ({...row, 'FECHA REPROGRAMACION': row['FECHA REPROGRAMACION']||'', 'OBSERVACION': row['OBSERVACION']||''}));
        }

        let tableHTML = '';
        
        // Si est√° pendiente, mostrar tabla editable
        if(reprog.estado==='pendiente' && datos.length>0) {
            const cols = Object.keys(datos[0] || {}).filter(c => c!=='FECHA REPROGRAMACION' && c!=='OBSERVACION');
            const allCols = ['FECHA REPROGRAMACION', 'OBSERVACION', ...cols]; 

            tableHTML = `
                <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 10px 12px; border-radius: 6px; margin: 12px 0 8px 0; font-size: 12px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-hand-point-right" style="font-size: 16px;"></i>
                    <span style="font-weight: 600;">Desliza horizontalmente para ver todas las columnas</span>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr>${allCols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${datos.map((row, i) => `<tr>${allCols.map(col => renderCell(col, row, i, edicionId)).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                </div>
                <button class="btn ${isOnline?'btn-success':'btn-warning'}" onclick="guardarRespuestas('${reprog.mes}', '${reprog.id}', '${edicionId}', '${reprog.nombreHojaActual || ''}')">
                    <i class="fas ${isOnline?'fa-check':'fa-save'}"></i> ${isOnline?'Enviar Respuesta':'Guardar Offline'}
                </button>
            `;
        } 
        // Si YA est√° respondida, mostrar tabla SOLO LECTURA (Historial)
        else if (reprog.estado === 'respondida' && datos.length > 0) {
             const cols = Object.keys(datos[0] || {});
             tableHTML = `
                <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 10px 12px; border-radius: 6px; margin: 12px 0 8px 0; font-size: 12px; color: #065f46; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle" style="font-size: 16px;"></i>
                    <span style="font-weight: 600;">Respondida - Desliza para ver todos los datos</span>
                </div>
                <div class="table-wrapper" style="opacity:0.8;">
                    <table class="data-table">
                        <thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${datos.map(row => `<tr>${cols.map(col => `<td>${row[col]||'-'}</td>`).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:10px; font-size:12px; color:var(--success); font-weight:600; text-align:center;">
                    <i class="fas fa-check-double"></i> Enviado el: ${new Date(reprog.fechaRespuesta).toLocaleString()}
                </div>
            `;
        }

        return `
            <div class="reprog-card tipo-${tipo}">
                <div class="card-header">
                    <div>
                        <div class="card-title">
                            ${reprog.auxiliarNombre}
                            ${reprog.nombreHojaActual ? `<span style="display:inline-block;margin-left:10px;font-size:12px;padding:4px 10px;border-radius:8px;background:#fef3c7;color:#92400e;font-weight:600;">üìÑ ${reprog.nombreHojaActual}</span>` : ''}
                        </div>
                        <div class="card-subtitle"><i class="far fa-calendar"></i> ${fecha} &bull; ${datos.length} items</div>
                    </div>
                    <span class="status-badge ${estadoClass}">${reprog.estado}</span>
                </div>
                ${tableHTML}
            </div>
        `;
    }

    function renderCell(col, row, idx, id) {
        if(col==='FECHA REPROGRAMACION') 
            return `<td class="editable-cell"><input type="date" data-r="${id}" data-i="${idx}" data-f="${col}" value="${row[col]||''}" onchange="actualizarCelda(this)"></td>`;
        if(col==='OBSERVACION') 
            return `<td class="editable-cell"><textarea rows="2" data-r="${id}" data-i="${idx}" data-f="${col}" onchange="actualizarCelda(this)">${row[col]||''}</textarea></td>`;
        return `<td>${row[col]||'-'}</td>`;
    }

    window.actualizarCelda = function(el) {
        const {r, i, f} = el.dataset;
        if(datosEditados[r]) datosEditados[r][i][f] = el.value;
    };

    window.guardarRespuestas = async function(mes, reprogId, edicionId, nombreHoja = '') {
        // ‚úÖ USAR edicionId PARA ACCEDER A LOS DATOS (puede ser compuesto)
        // ‚úÖ USAR reprogId PARA GUARDAR EN FIREBASE (siempre es el ID real)
        const datos = datosEditados[edicionId];
        
        console.log('üîß guardarRespuestas llamada:', { mes, reprogId, edicionId, nombreHoja, tieneDatos: !!datos });
        
        if(!datos) {
            mostrarAlerta('error', 'No hay datos para guardar');
            return;
        }
        
        if(!datos || datos.length === 0) {
            mostrarAlerta('error', 'No hay datos para guardar');
            return;
        }

        if(datos.some(d => !d['FECHA REPROGRAMACION'] || !d['OBSERVACION'])) {
            if(!(await mostrarModal('Campos vac√≠os', '¬øEnviar con campos vac√≠os?'))) return;
        }

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        try {
            const updateData = { 
                estado: 'respondida', 
                fechaRespuesta: new Date().toISOString(),
                supervisorId: currentUser.uid,
                supervisorNombre: userData?.nombre || 'Supervisor',
                supervisorEmail: currentUser.email
            };
            
            // ‚úÖ GUARDAR SEG√öN EL TIPO DE DATOS
            if(tabActiva === 'reprogramaciones') {
                updateData.datosReprogramacion = datos;
                console.log('üíæ Guardando datosReprogramacion:', datos.length + ' filas');
            } else if (tabActiva === 'pendientes') {
                if(nombreHoja) {
                    // Estructura nueva por hoja
                    if(!updateData.datosPendientesPorHoja) {
                        updateData.datosPendientesPorHoja = {};
                    }
                    updateData.datosPendientesPorHoja[nombreHoja] = datos;
                    console.log('üíæ Guardando datosPendientesPorHoja["' + nombreHoja + '"]:', datos.length + ' filas');
                } else {
                    // Estructura antigua
                    updateData.datosPendientes = datos;
                    console.log('üíæ Guardando datosPendientes:', datos.length + ' filas');
                }
            }

            // ‚úÖ GUARDAR EN FIREBASE CON EL ID REAL
            if(isOnline) {
                await update(ref(db, `reprogramaciones/${mes}/${reprogId}`), updateData);
                console.log('‚úÖ Guardado en Firebase:', `reprogramaciones/${mes}/${reprogId}`);
            } else {
                console.warn('‚ö†Ô∏è Sin conexi√≥n, no se pudo guardar en Firebase');
            }
            
            // ‚úÖ NOTIFICAR A CADA AUXILIAR INDIVIDUALMENTE
            try {
                console.log('üìß Obteniendo auxiliares...');
                const auxs = await obtenerTodasLasAuxiliares();
                console.log('üë• Auxiliares encontradas:', auxs.length);
                
                if(auxs.length > 0) {
                    const reprogOriginal = todasReprogramaciones.find(r => r.id === reprogId);
                    const totalReg = (reprogOriginal?.totalRegistrosReprogramacion || 0) + 
                                     (reprogOriginal?.totalRegistrosPendientes || 0);
                    
                    // ‚úÖ ENVIAR UN EMAIL A CADA AUXILIAR (NO ARRAY)
                    for (const auxiliar of auxs) {
                        try {
                            console.log('üì® Enviando email a:', auxiliar.email);
                            
                            await notificarAuxiliarReprogramacionCompletada({
                                auxiliarEmail: auxiliar.email,        // ‚úÖ STRING individual
                                auxiliarNombre: auxiliar.nombre,
                                supervisorNombre: userData?.nombre || 'Supervisor',
                                zona: reprogOriginal?.zona || 'N/A',
                                archivoNombre: reprogOriginal?.archivoNombre || 'archivo.xlsx',
                                totalRegistros: totalReg || datos.length,
                                fechaRespuesta: updateData.fechaRespuesta
                            });
                            
                            console.log('‚úÖ Email enviado correctamente a:', auxiliar.email);
                        } catch (emailError) {
                            console.error('‚ùå Error enviando email a ' + auxiliar.email + ':', emailError);
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è No hay auxiliares para notificar');
                }
            } catch(notifError) {
                console.error('‚ùå Error en notificaci√≥n:', notifError);
            }
            
            // ‚úÖ ACTUALIZAR ESTADO LOCAL (borrar cache de edici√≥n)
            delete datosEditados[edicionId];
            const idx = todasReprogramaciones.findIndex(r => r.id === reprogId);
            if(idx !== -1) {
                todasReprogramaciones[idx].estado = 'respondida';
                todasReprogramaciones[idx].fechaRespuesta = updateData.fechaRespuesta;
                
                if(tabActiva === 'reprogramaciones') {
                    todasReprogramaciones[idx].datosReprogramacion = datos;
                } else if(tabActiva === 'pendientes') {
                    if(nombreHoja && todasReprogramaciones[idx].datosPendientesPorHoja) {
                        todasReprogramaciones[idx].datosPendientesPorHoja[nombreHoja] = datos;
                    } else {
                        todasReprogramaciones[idx].datosPendientes = datos;
                    }
                }
            }
            
            actualizarEstadisticas();
            mostrarReprogramaciones();
            
            mostrarAlerta('success', '‚úÖ Respuesta enviada y emails notificados');
            btn.disabled = false;
            btn.innerHTML = originalText;

        } catch(error) {
            console.error('‚ùå Error cr√≠tico al guardar:', error);
            mostrarAlerta('error', 'Error: ' + error.message);
            btn.disabled = false; 
            btn.innerHTML = originalText;
        }
    };

    // UI Helpers
    function mostrarAlerta(tipo, msg) {
        const toast = document.getElementById('mainToast');
        const icon = document.getElementById('toastIcon');
        document.getElementById('toastMsg').textContent = msg;
        
        toast.className = `alert-toast show ${tipo}`;
        icon.innerHTML = tipo==='success' ? '<i class="fas fa-check-circle" style="color:var(--success);font-size:20px;"></i>' : 
                         tipo==='error' ? '<i class="fas fa-times-circle" style="color:var(--error);font-size:20px;"></i>' : 
                         '<i class="fas fa-exclamation-circle" style="color:var(--warning);font-size:20px;"></i>';
                         
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function mostrarModal(titulo, msg) {
        return new Promise(resolve => {
            const el = document.getElementById('modalOverlay');
            document.getElementById('modalTitle').textContent = titulo;
            document.getElementById('modalMessage').textContent = msg;
            el.classList.add('show');
            
            const ok = document.getElementById('modalConfirm');
            const cancel = document.getElementById('modalCancel');
            
            const close = (res) => {
                el.classList.remove('show');
                ok.replaceWith(ok.cloneNode(true));
                cancel.replaceWith(cancel.cloneNode(true));
                resolve(res);
            };
            
            ok.onclick = () => close(true);
            cancel.onclick = () => close(false);
        });
    }

    window.cerrarSesion = () => signOut(auth);
</script>
</body>
</html>
